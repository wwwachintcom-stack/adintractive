<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Particle System</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #050505; color: white; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        #webcam { position: absolute; bottom: 10px; right: 10px; width: 180px; height: 135px; border: 2px solid #00ffff; border-radius: 8px; transform: scaleX(-1); background: #222; }
        canvas { display: block; }
        .loading-hint { color: #00ffff; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="ui">
        <h1>Hand Particle System</h1>
        <p>Allow camera access to interact.</p>
        <p class="loading-hint">Status: <span id="status">Initializing...</span></p>
    </div>

    <video id="webcam" autoplay playsinline></video>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const statusEl = document.getElementById('status');
        let scene, camera, renderer, particles;
        const PARTICLE_COUNT = 8000;
        let positions;

        // 1. Initialize 3D Scene
        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Create Particles
            const geo = new THREE.BufferGeometry();
            positions = new Float32Array(PARTICLE_COUNT * 3);
            
            // Random initial spray
            for (let i = 0; i < PARTICLE_COUNT * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 10;
            }

            geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const mat = new THREE.PointsMaterial({
                size: 0.04,
                color: 0x00ffff,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geo, mat);
            scene.add(particles);
            
            statusEl.innerText = "3D Ready. Waiting for Camera...";
        }

        // 2. Setup Hand Tracking
        const videoElement = document.getElementById('webcam');
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults((results) => {
            statusEl.innerText = "Hand Detected!";
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const indexTip = hand[8]; // Index Finger Tip
                
                // Convert MediaPipe coords (0-1) to Three.js coords (-5 to 5)
                const tx = (0.5 - indexTip.x) * 12;
                const ty = (0.5 - indexTip.y) * -12;

                animateParticles(tx, ty);
            } else {
                statusEl.innerText = "No hand in view";
            }
        });

        function animateParticles(targetX, targetY) {
            const posAttr = particles.geometry.attributes.position;
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const ix = i * 3;
                // Move towards hand position with "organic" jitter
                posAttr.array[ix] += (targetX - posAttr.array[ix]) * 0.05 + (Math.random() - 0.5) * 0.02;
                posAttr.array[ix+1] += (targetY - posAttr.array[ix+1]) * 0.05 + (Math.random() - 0.5) * 0.02;
            }
            posAttr.needsUpdate = true;
        }

        function render() {
            requestAnimationFrame(render);
            // Slow rotation when no hand is moving
            particles.rotation.y += 0.001;
            renderer.render(scene, camera);
        }

        // 3. Start Camera
        const cameraPipe = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });

        // Initialize and Start
        initThree();
        render();
        cameraPipe.start().catch(err => {
            statusEl.innerText = "Error: Camera blocked or not found.";
            console.error(err);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>